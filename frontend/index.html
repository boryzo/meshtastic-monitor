<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meshtastic Monitor</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="title">Meshtastic Monitor</div>
        <div class="subtitle">
          Mesh: <span id="meshHost">‚Äî</span>
          <span class="dot">‚Ä¢</span>
          <span id="connStatus" class="status status-unknown">Checking‚Ä¶</span>
        </div>
      </div>

      <nav class="actions top-nav" aria-label="Primary">
        <button class="btn" data-main-tab="nodes">üß≠ Nodes</button>
        <button class="btn" data-main-tab="channels">üí¨ Channels</button>
        <button class="btn" data-main-tab="status">üü¢ Status</button>
        <button class="btn" data-main-tab="stats">üìä Stats</button>
        <button class="btn" data-main-tab="settings">‚öôÔ∏è Settings</button>
      </nav>
    </header>

    <main class="container">
      <section class="card tab-panel active" data-tab="status">
        <div class="card-header">
          <h2>Status</h2>
          <div class="row">
            <button id="btnCopyHealthJson" class="btn btn-secondary" type="button">
              Copy JSON
            </button>
            <button id="btnToggleHealthJson" class="btn btn-secondary" type="button">
              Show JSON
            </button>
            <a
              id="btnOpenHealthJson"
              class="btn btn-secondary"
              href="/api/status"
              target="_blank"
              rel="noreferrer"
              >Open JSON</a
            >
          </div>
        </div>
        <div class="status-meta muted" id="statusMeta">Loading‚Ä¶</div>
        <div id="statusError" class="muted"></div>
        <div class="status-grid">
          <div class="panel">
            <h3>Overview</h3>
            <div id="statusOverview" class="kv"></div>
          </div>
          <div class="panel">
            <h3>Power</h3>
            <div id="statusPower" class="kv"></div>
          </div>
          <div class="panel">
            <h3>Memory</h3>
            <div id="statusMemory" class="kv"></div>
          </div>
          <div class="panel">
            <h3>Airtime</h3>
            <div id="statusAirtime" class="kv"></div>
          </div>
          <div class="panel">
            <h3>Radio</h3>
            <div id="statusRadio" class="kv"></div>
          </div>
          <div class="panel">
            <h3>WiFi</h3>
            <div id="statusWifi" class="kv"></div>
          </div>
        </div>
        <pre id="healthJson" class="code hidden"></pre>
      </section>

      <section class="card tab-panel" data-tab="nodes">
        <div class="card-header">
          <h2>Nodes</h2>
          <div class="row">
            <input
              id="nodeFilter"
              class="input"
              placeholder="Filter by short/long/id‚Ä¶"
              autocomplete="off"
            />
            <div class="tabs">
              <button id="tabDirect" class="tab active" data-tab="direct">Direct</button>
              <button id="tabRelayed" class="tab" data-tab="relayed">Relayed</button>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="nodesTable">
            <thead>
              <tr>
                <th>Short</th>
                <th>Long</th>
                <th class="col-role">Role</th>
                <th class="col-device">Device</th>
                <th class="col-snr sortable" data-sort="snr">SNR</th>
                <th class="col-quality sortable" data-sort="quality">Quality</th>
                <th class="col-hops sortable" data-sort="hops">Hops</th>
                <th class="sortable" data-sort="age">Last Seen</th>
                <th class="col-id">ID</th>
              </tr>
            </thead>
            <tbody id="nodesTbody">
              <tr>
                <td colspan="9" class="muted">Loading‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card-footer muted" id="nodesMeta">‚Äî</div>
      </section>

      <section class="card tab-panel" data-tab="channels">
        <div class="card-header">
          <h2>Channels</h2>
          <div class="row">
            <div class="muted" id="channelsMeta">‚Äî</div>
            <div class="muted" id="messagesMeta">‚Äî</div>
            <select id="messagesHistoryLimit" class="input small">
              <option value="200">Last 200</option>
              <option value="1000">Last 1000</option>
              <option value="5000">Last 5000</option>
              <option value="0">All (slow)</option>
            </select>
            <div id="messageChannelTabs" class="tabs small"></div>
          </div>
        </div>

        <div id="messagesList" class="messages"></div>

        <form id="sendForm" class="send">
          <div class="field">
            <label for="sendText">Text</label>
            <textarea id="sendText" class="input" rows="3" required></textarea>
          </div>
          <div class="field">
            <label for="sendChannel">Channel</label>
            <select id="sendChannel" class="input">
              <option value="">Auto (default)</option>
            </select>
            <div class="hint">Pick a channel to send on, or leave Auto.</div>
          </div>
          <div class="row">
            <button class="btn btn-primary" type="submit">Send</button>
            <div id="sendResult" class="muted"></div>
          </div>
        </form>
      </section>

      <section class="card tab-panel" data-tab="stats">
        <div class="card-header">
          <h2>Stats</h2>
          <div class="row">
            <div class="muted" id="statsMeta">‚Äî</div>
          </div>
        </div>
        <div id="statsSummary" class="stats-grid">
          <div class="muted">Loading‚Ä¶</div>
        </div>
        <div class="stats-panels">
          <div class="panel wide">
            <h3>Nodes visible (live)</h3>
            <div id="statsNodesVisible" class="bars"></div>
          </div>
          <div class="panel wide">
            <h3>TCP Relay</h3>
            <div id="statsRelay" class="list"></div>
          </div>
          <div class="panel wide">
            <h3>Messages (hourly)</h3>
            <div id="statsHourly" class="bars"></div>
          </div>
          <div class="panel wide">
            <h3>Status (latest)</h3>
            <div id="statsStatusSummary" class="kv"></div>
          </div>
          <div class="panel wide">
            <h3>Battery % (recent)</h3>
            <div id="statsBattery" class="bars"></div>
          </div>
          <div class="panel wide">
            <h3>Channel Utilization (recent)</h3>
            <div id="statsChannelUtil" class="bars"></div>
          </div>
          <div class="panel wide">
            <h3>WiFi RSSI (recent)</h3>
            <div id="statsWifiRssi" class="bars"></div>
          </div>
          <div class="panel">
            <h3>Apps</h3>
            <div id="statsApps" class="list"></div>
          </div>
          <div class="panel">
            <h3>Requests to Me</h3>
            <div id="statsAppRequests" class="list"></div>
          </div>
          <div class="panel">
            <h3>Top From</h3>
            <div id="statsTopFrom" class="list"></div>
          </div>
          <div class="panel">
            <h3>Top To</h3>
            <div id="statsTopTo" class="list"></div>
          </div>
          <div class="panel">
            <h3>Most Visible (7d)</h3>
            <div id="statsMostVisible" class="list"></div>
          </div>
          <div class="panel">
            <h3>Zero-hop Time (7d)</h3>
            <div id="statsZeroHop" class="list"></div>
          </div>
          <div class="panel">
            <h3>SNR (7d)</h3>
            <div id="statsSnr" class="list"></div>
          </div>
          <div class="panel">
            <h3>Flaky (hop changes, 7d)</h3>
            <div id="statsFlaky" class="list"></div>
          </div>
          <div class="panel">
            <h3>Top Requesters (7d)</h3>
            <div id="statsRequesters" class="list"></div>
          </div>
          <div class="panel">
            <h3>Recent Events</h3>
            <div id="statsEvents" class="list"></div>
          </div>
        </div>
      </section>

      <section class="card tab-panel" data-tab="status">
        <div class="card-header">
          <h2>My Radio</h2>
          <div class="row">
            <div class="muted" id="radioMeta">‚Äî</div>
          </div>
        </div>
        <div id="radioDetails" class="kv">
          <div class="muted">Loading‚Ä¶</div>
        </div>
        <div class="divider"></div>
        <div class="card-header">
          <h2>Diagnostics</h2>
          <div class="row">
            <div class="muted" id="diagMeta">‚Äî</div>
          </div>
        </div>
        <div id="diagList" class="list"></div>
      </section>

      <section class="card tab-panel" data-tab="settings">
        <div class="card-header">
          <h2>Settings</h2>
        </div>
        <div class="settings-body">
          <div class="field">
            <label for="apiBaseUrl">API Base URL (optional)</label>
            <input id="apiBaseUrl" class="input" placeholder="http://localhost:8080" />
            <div class="hint">Leave blank when using the built-in UI.</div>
          </div>

          <div class="row">
            <div class="field">
              <label for="meshHostInput">Meshtastic IP / Host</label>
              <input id="meshHostInput" class="input" placeholder="your-mesh-host" />
            </div>
            <div class="field">
              <label for="meshPortInput">Port</label>
              <input id="meshPortInput" class="input" placeholder="4403" inputmode="numeric" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>
              <input id="relayEnabled" type="checkbox" />
              Enable TCP relay
            </label>
            <div class="hint">Allow multiple TCP clients by relaying through this app.</div>
          </div>

          <div class="row">
            <div class="field">
              <label for="relayHost">Relay listen host</label>
              <input id="relayHost" class="input" placeholder="0.0.0.0" />
            </div>
            <div class="field">
              <label for="relayPort">Relay listen port</label>
              <input id="relayPort" class="input" placeholder="4403" inputmode="numeric" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>
              <input id="smsEnabled" type="checkbox" />
              Enable SMS relay
            </label>
            <div class="hint">Forward every received message through the SMS gateway.</div>
          </div>

          <div class="field">
            <label for="smsApiUrl">SMS API URL</label>
            <input id="smsApiUrl" class="input" placeholder="https://your-sms-gateway.example/api" />
          </div>

          <div class="row">
            <div class="field">
              <label for="smsPhone">SMS Phone</label>
              <input id="smsPhone" class="input" placeholder="600000000" />
            </div>
            <div class="field">
              <label for="smsApiKey">SMS API Key</label>
              <input id="smsApiKey" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" />
              <div class="hint" id="smsKeyHint">Leave blank to keep existing key.</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="smsAllowFromIds">SMS Allowed From IDs</label>
              <input id="smsAllowFromIds" class="input" placeholder="ALL or !abcd1234,!beef5678" />
              <div class="hint">Comma-separated sender IDs or <code>ALL</code>.</div>
            </div>
            <div class="field">
              <label for="smsAllowTypes">SMS Allowed Types</label>
              <input id="smsAllowTypes" class="input" placeholder="ALL or TEXT,POSITION_APP,5" />
              <div class="hint">Comma-separated types (TEXT, app names, or port numbers) or <code>ALL</code>.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label for="statsCacheMinutes">Stats cache (minutes)</label>
            <input id="statsCacheMinutes" class="input" placeholder="30" inputmode="numeric" />
            <div class="hint">Recompute heavy stats on a schedule (default 30 minutes).</div>
          </div>
        </div>
        <div class="card-footer">
          <div class="row">
            <button id="btnSaveSettings" class="btn btn-primary" type="button">
              Save & Apply
            </button>
            <button id="btnExportSettings" class="btn btn-secondary" type="button">
              Export Config
            </button>
          </div>
          <div class="hint">Settings are applied via <code>/api/config</code>.</div>
        </div>
      </section>
    </main>

    <!-- Node details modal -->
    <div id="nodeModalBackdrop" class="backdrop hidden" aria-hidden="true"></div>
    <div id="nodeModal" class="modal hidden node-modal" role="dialog" aria-modal="true" aria-label="Node Details">
      <div class="modal-header">
        <h3 id="nodeModalTitle">Node Details</h3>
        <button id="btnCloseNodeModal" class="btn btn-secondary" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="muted" id="nodeDetailsMeta">‚Äî</div>
        </div>
        <div id="nodeDetails" class="kv two-col">
          <div class="muted">Loading‚Ä¶</div>
        </div>
        <div class="divider"></div>
        <div class="node-chat">
          <h4>Messaging</h4>
          <div id="nodeMessages" class="messages compact"></div>
          <form id="nodeSendForm" class="send">
            <div class="field">
              <label for="nodeSendText">Text</label>
              <textarea id="nodeSendText" class="input" rows="3" required></textarea>
            </div>
            <div class="field">
              <label for="nodeSendChannel">Channel</label>
              <select id="nodeSendChannel" class="input">
                <option value="">Auto (default)</option>
              </select>
              <div class="hint">Optional: choose a channel for this direct message.</div>
            </div>
            <div class="row">
              <button class="btn btn-primary" type="submit">Send</button>
              <div id="nodeSendResult" class="muted"></div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="/static/channel_tabs.js"></script>
    <script src="/static/app.js"></script>
  </body>
</html>
