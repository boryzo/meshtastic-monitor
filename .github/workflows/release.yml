name: Release (bump + tag)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Optional version (e.g. 0.5.1). Leave empty to bump patch in 0.1.X"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  bump-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version in setup.cfg
        id: bump
        env:
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          python - <<'PY'
          import os
          import re
          
          def ensure_semver(v: str) -> list[str]:
              parts = v.split(".")
              if len(parts) != 3 or not all(p.isdigit() for p in parts):
                  raise SystemExit(f"Invalid version: {v!r} (expected X.Y.Z)")
              return parts
          
          path = "setup.cfg"
          raw = open(path, "r", encoding="utf-8").read().splitlines(True)
          
          current = None
          in_metadata = False
          for line in raw:
              if line.strip().startswith("["):
                  in_metadata = line.strip().lower() == "[metadata]"
                  continue
              if in_metadata and line.strip().lower().startswith("version"):
                  current = line.split("=", 1)[1].strip()
                  break
          
          if not current:
              raise SystemExit("Could not find version in [metadata] section of setup.cfg")
          
          inp = os.environ.get("INPUT_VERSION", "").strip()
          if inp:
              ensure_semver(inp)
              new = inp
          else:
              parts = ensure_semver(current)
              if parts[0] != "0" or parts[1] != "1":
                  raise SystemExit(f"Auto bump expects current version 0.1.X, got {current}")
              parts[2] = str(int(parts[2]) + 1)
              new = ".".join(parts)
          
          out_lines = []
          in_metadata = False
          replaced = False
          for line in raw:
              if line.strip().startswith("["):
                  in_metadata = line.strip().lower() == "[metadata]"
                  out_lines.append(line)
                  continue
              if in_metadata and line.strip().lower().startswith("version"):
                  out_lines.append(f"version = {new}\n")
                  replaced = True
              else:
                  out_lines.append(line)
          
          if not replaced:
              raise SystemExit("Failed to update version in setup.cfg")
          
          with open(path, "w", encoding="utf-8") as f:
              f.writelines(out_lines)
          
          out = os.environ.get("GITHUB_OUTPUT")
          if out:
              with open(out, "a", encoding="utf-8") as f:
                  f.write(f"version={new}\n")
          print(f"New version: {new}")
          PY

      - name: Commit and tag
        env:
          VERSION: ${{ steps.bump.outputs.version }}
        run: |
          git add setup.cfg
          git commit -m "Bump version to v${VERSION}"
          if git rev-parse -q --verify "refs/tags/v${VERSION}"; then
            echo "Tag v${VERSION} already exists" >&2
            exit 1
          fi
          git tag "v${VERSION}"
          git push origin HEAD:main --tags
